---
title: Uganda Air Quality Forecast
author: Brian Stefan Ssali
date: '2020-05-09'
slug: uganda-air-quality-forecast
categories: []
tags:
  - R
  - ZindiChallenge
subtitle: ''
summary: ''
authors: []
lastmod: '2020-05-09T17:54:07+03:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
code_folding: hide
draft: true 
---



<p>We are going to be looking at the air quality of Uganda. The data is from a Zindi challenge</p>
<p>Looking at the nature of the data</p>
<p>The day’s data is nested within the key columns. As such the dta has to be reshaped, the day’s column created and the key columns are hihloghted. After cleaning the data, this is what we end up with</p>
<pre class="r"><code># key_columns &lt;-  air_quality_dirty %&gt;% select(-ID,-location,-target) %&gt;% colnames()
#
# #editing training and test data
# air_quality_cleaned &lt;- air_quality_dirty %&gt;% distinct(ID,location,target)
# for(i in 1:length(key_columns)){
#   data &lt;- air_quality_dirty %&gt;% select(ID,location,key_columns[i]) %&gt;% tidyr::separate(!!paste0(key_columns[i]),paste0(key_columns[i],1:120),&quot;,&quot;) %&gt;%
#     tidyr::pivot_longer(c(-ID,-location)) %&gt;% select(-name) %&gt;% mutate(value = as.numeric(value)) %&gt;%
#     group_by(ID,location) %&gt;% summarise_if(is.numeric,list(~min(.),~max(.),~mean(.),~sd(.),~median(.)),) %&gt;%
#     mutate(var = sd**2,range = max - min) %&gt;% rename_at(vars(-ID,-location),funs(paste0(key_columns[i],&quot;_&quot;,.)))
#
#   air_quality_cleaned &lt;-  air_quality_cleaned %&gt;% inner_join(data)
# }
# air_quality_cleaned &lt;- metadata %&gt;% select(-X1,-dist_motorway) %&gt;% left_join(air_quality_cleaned) %&gt;%
#   mutate(location = factor(location),location = as.numeric(location))</code></pre>
<pre class="r"><code># purrr::map_dfc(air_quality_dirty %&gt;% select(temp,precip),tidyr::separate(!!paste0(.),paste0(.,1:120),&quot;,&quot;)) %&gt;% head()
# air_quality_dirty %&gt;% head() %&gt;% select(temp) %&gt;% mutate(colz = purrr::map(reshape2::colsplit(.,pattern = &quot;,&quot;,names = paste0(1:120,.))))
# air_quality_dirty %&gt;% head() %&gt;% select(temp)  %&gt;%splitstackshape::cSplit(names(.))  %&gt;% View()
# split_df &lt;- air_quality_dirty %&gt;% head() %&gt;% select(temp,precip,rel_humidity,wind_dir,wind_spd,atmos_press)

# air_quality_cleaned &lt;- air_quality_dirty %&gt;%  splitstackshape::cSplit(c(&#39;temp&#39;,&#39;precip&#39;,&#39;rel_humidity&#39;,&#39;wind_dir&#39;,&#39;wind_spd&#39;,&#39;atmos_press&#39;),sep = &quot;,&quot;) %&gt;%
#   pivot_longer(cols = c(-ID,-location,-target),names_to = &quot;variable&quot;) %&gt;%
#   filter(str_detect(variable,paste0(c(1:120),collapse = &quot;|&quot;))==T) %&gt;%
#   mutate(Day = str_replace_all(variable,pattern = &quot;\\D&quot;,replacement = &quot;&quot;),variable = str_replace_all(variable,pattern = &quot;\\d&quot;,replacement = &quot;&quot;)) %&gt;%
#   pivot_wider(names_from = variable,values_from = value) %&gt;%
#   filter_at(vars(-ID,-location,-target,-Day),all_vars(is.na(.)==F)) %&gt;%
#   left_join(metadata %&gt;% select(-X1,-dist_motorway)) %&gt;%
#    group_by(ID,location,target) %&gt;% summarise_if(is.numeric,mean,na.rm=T) %&gt;%
#   data.frame(stringsAsFactors = F) %&gt;% mutate_at(vars(-ID,-location,-target),list(~case_when(is.na(.)~mean(.,na.rm = T),TRUE~.)))
#
#
# air_quality_cleaned1 &lt;- air_quality_cleaned %&gt;%  mutate(location = factor(location),location = as.numeric(location)) #%&gt;%select(-ID)
# purrr::map2_df(colnames(split_df),split_df,~reshape2::colsplit(.y,pattern = &quot;,&quot;,names = paste0(.x,1:121))) %&gt;% View()</code></pre>
<pre class="r"><code># air_quality_cleaned %&gt;% head() %&gt;% flextable()</code></pre>
<div id="understand-the-data" class="section level1">
<h1>Understand the Data</h1>
<pre class="r"><code># air_quality_cleaned %&gt;% select_if(is.numeric) %&gt;% corrr::correlate() %&gt;% corrr::rplot()</code></pre>
<pre class="r"><code># split &lt;- rsample::initial_split(air_quality_cleaned1)
# train = rsample::training(split)  %&gt;% mutate(location = factor(location)) #%&gt;% select(-ID)
# test = rsample::testing(split)%&gt;% mutate(location = factor(location))#%&gt;% select(-ID)
# val = train %&gt;% rsample::initial_split(0.8) %&gt;% rsample::training()</code></pre>
</div>
<div id="buid-model" class="section level1">
<h1>Buid Model</h1>
<pre class="r"><code># #prepaing the data
# bec &lt;- recipe(target ~. ,data = train) %&gt;%
#   step_BoxCox(all_numeric()) %&gt;%
#   step_normalize(all_numeric()) %&gt;%
#   prep()
#
# val_norm &lt;- bake(bec,new_data = val,all_predictors())
# test_norm &lt;- bake(bec,new_data = test,all_predictors())</code></pre>
<pre class="r"><code># set.seed(123)
# nnet &lt;- parsnip::mlp(epochs = 50,hidden_units = 5,dropout = 0.1) %&gt;%
#   set_mode(&quot;regression&quot;) %&gt;%
#   set_engine(&quot;keras&quot;,verbose =0) %&gt;%
#   fit(target~. ,data =juice(bec))
#
# nnet</code></pre>
<pre class="r"><code># resultz &lt;- val %&gt;% bind_cols(predict(nnet, val))</code></pre>
<pre class="r"><code># test_pred &lt;- predict(nnet,test_norm)
# train_pred &lt;-  predict(nnet,juice(bec))
# val_pred &lt;- predict(nnet,val_norm)
#
# #a &lt;- data.frame()
# b &lt;- data.frame(train = round(Metrics::rmse(train$target,train_pred),3),
#                 val = round(Metrics::rmse(val$target,val_pred),3),
#                 test = round(Metrics::rmse(test$target,test_pred),3))
# b</code></pre>
<p>#saturday
penny
big shot
shutter island
inception
the departed</p>
</div>
